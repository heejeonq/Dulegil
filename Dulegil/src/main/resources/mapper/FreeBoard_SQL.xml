<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="free">

<!-- 페이지카운트 -->
<select id="getCnt" resultType="integer" parameterType="hashmap">
SELECT COUNT (*) AS CNT
FROM
(SELECT T.BLTNBOARD_NO,POST_NO,MEMBER_NO,TITLE,CONTENTS,IMG_FILE,HIT,REG_DT
FROM BOARD_TYPE T INNER JOIN BULLETIN_BOARD B
ON T.BLTNBOARD_NO = B.BLTNBOARD_NO
WHERE B.DEL_DT IS NULL
AND T.BLTNBOARD_NO =3)G INNER JOIN MEMBER M
ON G.MEMBER_NO=M.MEMBER_NO
<!-- 검색어가 널이 또는 '' 가 아니라면 -->
<if test="searchTxt != null and searchTxt !=''">
	<choose>
		<!-- 구분이 제목일때  #{serchTxt} 들어가묜-->
		<when test="searchGbn eq 0">
		AND TITLE LIKE '%' || #{searchTxt} || '%'
		</when>
		<when test="searchGbn eq 1">
		AND CONTENTS LIKE '%'|| #{searchTxt}||'%'
		</when>
		<when test="searchGbn eq 2">
		AND NM LIKE '%'|| #{searchTxt} ||'%'
		</when>
	</choose>		
</if>	

</select>

<!-- 목록 -->
<select id="getFreeList" parameterType="hashmap" resultType="hashmap">	
SELECT F.POST_NO,F.NM,F.TITLE,F.HIT,F.DT,F.CONTENTS,F.IMG_FILE,F.IMG_FILE
FROM(SELECT G.POST_NO,M.NM,G.TITLE,G.HIT,G.DT,G.CONTENTS,G.RNUM,G.IMG_FILE
     FROM (SELECT POST_NO,TITLE,HIT,CONTENTS,MEMBER_NO,B.IMG_FILE,
                CASE WHEN TO_CHAR(B.REG_DT, 'YY.MM.DD') = TO_CHAR(SYSDATE,'YY.MM.DD')
            	THEN TO_CHAR(B.REG_DT, 'HH24:MI')
            	ELSE TO_CHAR(B.REG_DT,'YY.MM.DD')
       			END AS DT,
                ROW_NUMBER() OVER(ORDER BY B.POST_NO DESC) AS RNUM  
                FROM BOARD_TYPE T INNER JOIN BULLETIN_BOARD B
                ON T.BLTNBOARD_NO = B.BLTNBOARD_NO
                WHERE B.DEL_DT IS NULL
                AND T.BLTNBOARD_NO =3 )G  
        INNER JOIN MEMBER M 
        ON G.MEMBER_NO = M.MEMBER_NO
		<if test="searchTxt != null and searchTxt !=''">
			<choose>
				<!-- 구분이 제목일때  #{serchTxt} 들어가묜-->
				<when test="searchGbn eq 0">
				AND TITLE LIKE '%' || #{searchTxt} || '%'
				</when>
				<when test="searchGbn eq 1">
				AND CONTENTS LIKE '%'|| #{searchTxt}||'%'
				</when>
				<when test="searchGbn eq 2">
				AND NM LIKE '%'|| #{searchTxt} ||'%'
				</when>
			</choose>		
		</if>
        )F
        WHERE F.RNUM BETWEEN #{start} AND #{end}
</select>

<!-- 게시글등록 -->
<insert id="insert" parameterType="hashmap">
INSERT INTO BULLETIN_BOARD (POST_NO,BLTNBOARD_NO,MEMBER_NO,TITLE,CONTENTS,REG_DT,IMG_FILE)
VALUES (COMMUNITY_SEQ.NEXTVAL,3,#{memberNo},#{title},#{contents},SYSDATE,#{imgFile})
</insert>


<!-- 게시글 삭제 -->
<update id="delete" parameterType="hashmap">
UPDATE BULLETIN_BOARD SET DEL_DT = SYSDATE
WHERE POST_NO= #{no}
</update>

<!-- 게시글 수정 -->
<update id="update"  parameterType="hashmap">
UPDATE BULLETIN_BOARD SET TITLE=#{title}, CONTENTS=#{contents}, IMG_FILE AS B_IMG={bIMG}
WHERE POST_NO=#{no}
</update>

<!-- 조회수 -->
<update id="updateTHit" parameterType="hashmap">
UPDATE BULLETIN_BOARD SET HIT = HIT+1
WHERE BLTNBOARD_NO =3
AND POST_NO= #{no}
</update>

<!-- 상세보기 -->
<select id="getF" parameterType="hashmap" resultType="hashmap">
SELECT G.POST_NO,G.BLTNBOARD_NO,G.MEMBER_NO,M.NM,G.TITLE,G.HIT,G.DT,G.CONTENTS,G.IMG_FILE AS B_IMG,M.IMG_FILE AS M_IMG
     FROM (SELECT POST_NO,TITLE,HIT,CONTENTS,MEMBER_NO,B.BLTNBOARD_NO,B.IMG_FILE,REG_DT,DEL_DT,
                CASE WHEN TO_CHAR(B.REG_DT, 'YY.MM.DD') = TO_CHAR(SYSDATE,'YY.MM.DD')
               THEN TO_CHAR(B.REG_DT, 'HH24:MI')
               ELSE TO_CHAR(B.REG_DT,'YY.MM.DD')
                END AS DT,
                ROW_NUMBER() OVER(ORDER BY B.POST_NO DESC) AS RNUM  
            FROM BOARD_TYPE T INNER JOIN BULLETIN_BOARD B
                ON T.BLTNBOARD_NO = B.BLTNBOARD_NO
                WHERE B.DEL_DT IS NULL
                 AND T.BLTNBOARD_NO =3 )G  
        INNER JOIN MEMBER M 
        ON G.MEMBER_NO = M.MEMBER_NO
      WHERE G.POST_NO=#{no}
</select>




</mapper>
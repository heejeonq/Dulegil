<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="adReport">



	<!-- 목록 -->
	<select id="list" resultType="hashmap">
		SELECT A.REPORT_NO, A.REPORT_MEMBER_NO,A.ACCUSER,
		A.TARGET_REPORT_MEMBER_NO,A.ACCUSED, A.PROCESS_NO, A.REPORT_TYPE_NM,
		A.CATE ,A.REG_DT
		FROM(SELECT R.REPORT_NO, R.REPORT_MEMBER_NO, C.NM AS ACCUSER,
		R.TARGET_REPORT_MEMBER_NO,P.NM AS ACCUSED, R.PROCESS_NO,
		RT.REPORT_TYPE_NM,
		CASE
		WHEN COMMENT_NO IS NOT NULL AND POST_NO IS NOT NULL
		THEN '댓글'
		WHEN COMMENT_NO IS NULL AND POST_NO IS NOT NULL
		THEN '글'
		ELSE '회원'
		END AS CATE, R.REG_DT,
		ROW_NUMBER() OVER(ORDER BY R.REG_DT DESC)AS RNK
		FROM REPORT R INNER JOIN REPORT_TYPE RT
		ON R.REPORT_TYPE_NO = RT.REPORT_TYPE_NO
		LEFT JOIN MEMBER P
		ON R.TARGET_REPORT_MEMBER_NO = P.MEMBER_NO
		LEFT JOIN MEMBER C
		ON R.REPORT_MEMBER_NO = C.MEMBER_NO
		WHERE R.DEL_DT IS NULL

		<if test="searchTxt != null and searchTxt != ''">
			<choose>
				<when test="searchGbn == 0">
					AND CATE LIKE '%' || #{searchTxt} || '%'
				</when>
				<when test="searchGbn == 1">
					AND ACCUSER '%' || #{searchTxt} || '%'
				</when>
				<when test="searchGbn == 2">
					AND ACCUSED LIKE '%' || #{searchTxt} || '%'
				</when>
				<when test="searchGbn == 3">
					AND REPORT_TYPE_NM LIKE '%' || #{searchTxt} || '%'
				</when>
			</choose>
		</if>
		)A
		WHERE A.RNK BETWEEN #{start} AND #{end}
	</select>




	<!-- 페이징 -->
	<select id="cnt" parameterType="hashmap" resultType="integer">
		SELECT COUNT(*) AS CNT
	FROM(SELECT R.REPORT_NO, R.REPORT_MEMBER_NO, C.NM AS ACCUSER,
		R.TARGET_REPORT_MEMBER_NO,P.NM AS ACCUSED, R.PROCESS_NO,
		RT.REPORT_TYPE_NM,
		CASE
		WHEN COMMENT_NO IS NOT NULL AND POST_NO IS NOT NULL
		THEN '댓글'
		WHEN COMMENT_NO IS NULL AND POST_NO IS NOT NULL
		THEN '글'
		ELSE '회원'
		END AS CATE, R.REG_DT
		FROM REPORT R INNER JOIN REPORT_TYPE RT
		ON R.REPORT_TYPE_NO = RT.REPORT_TYPE_NO
		LEFT JOIN MEMBER P
		ON R.TARGET_REPORT_MEMBER_NO = P.MEMBER_NO
		LEFT JOIN MEMBER C
		ON R.REPORT_MEMBER_NO = C.MEMBER_NO
		WHERE R.DEL_DT IS NULL

		<if test="searchTxt != null and searchTxt != ''">
			<choose>
				<when test="searchGbn == 0">
					AND CATE LIKE '%' || #{searchTxt} || '%'
				</when>
				<when test="searchGbn == 1">
					AND ACCUSER '%' || #{searchTxt} || '%'
				</when>
				<when test="searchGbn == 2">
					AND ACCUSED LIKE '%' || #{searchTxt} || '%'
				</when>
				<when test="searchGbn == 3">
					AND REPORT_TYPE_NM LIKE '%' || #{searchTxt} || '%'
				</when>
			</choose>
		</if>
	</select>





	<!-- 처리상태 업데이트 -->
	<update id="update" parameterType="hashmap">
		UPDATE REPORT SET
		<choose>
			<when test="process == 0">
				PROCESS_NO = 0
			</when>
			<when test="process == 1">
				PROCESS_NO = 1
			</when>
			<when test="process == 2">
				PROCESS_NO = 2
			</when>
			<when test="process == 3">
				PROCESS_NO = 3
			</when>
		</choose>		
		WHERE REPORT_NO = #{no}
	</update>




	<!-- 개별 삭제 -->
	<update id="del" parameterType="hashmap">
		UPDATE BULLETIN_BOARD SET DEL_DT = SYSDATE
		WHERE POST_NO = #{no}
	</update>



</mapper>